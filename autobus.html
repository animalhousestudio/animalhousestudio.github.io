<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suonatore d'Autobus (Debug Mode)</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='black' viewBox='0 0 16 16'%3e%3cpath d='M14 4H2C1.448 4 1 4.448 1 5v6c0 .552.448 1 1 1h1v1.5a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V12h6v1.5a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V12h1c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1zM3.5 11a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm9 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2zM13 8H3V6h10v2z'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=EB+Garamond:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- STILI GENERALI --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #fff; overflow: hidden; image-rendering: pixelated; }
        .retro-background, .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .retro-background { background: url('./images/intro.gif') center/cover no-repeat; }
        .scanlines { background: repeating-linear-gradient(transparent, transparent 2px, rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 4px); pointer-events: none; z-index: 2; }
        .content { position: relative; z-index: 10; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        .title { font-size: 2.5rem; font-weight: bold; margin-bottom: 1rem; opacity: 0; animation: fadeIn 0.7s ease-in-out 0.3s forwards; text-shadow: 0 0 10px rgba(255,255,255,0.5); background: rgba(0,0,0,0.7); border: 6px solid #fff; box-shadow: 0 0 0 2px rgba(0,0,0,0.7), 0 0 0 8px #fff; padding: 20px 30px; text-align: center; }
        .language-selector { font-size: 1rem; margin-bottom: 2rem; background: rgba(0,0,0,0.7); border: 2px solid #fff; padding: 0.5rem 1rem; opacity: 0; animation: fadeInRetro 0.8s ease-out 0.8s forwards; }
        .lang-option { cursor: pointer; text-transform: uppercase; padding: 0 0.5rem; }
        .lang-option:hover { text-shadow: 0 0 10px #fff; }
        .lang-option.active { color: #000; background: #fff; }
        .start-button { font-size: 2.5rem; font-weight: bold; color: #000; background: #fff; border: 4px solid #fff; padding: 1rem 3rem; cursor: pointer; display: none; margin-top: 2rem; }
        .start-button.visible { display: inline-block; animation: fadeInRetro 0.8s ease-out forwards; }
        
        /* --- NUOVI STILI PER DEBUG E SBLOCCO AUDIO --- */
        #debugLogContainer {
            position: fixed; top: 10px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.8); border: 1px solid #0f0;
            padding: 10px; font-family: 'Courier New', monospace; font-size: 12px;
            color: #0f0; width: calc(100% - 20px); max-height: 50vh; overflow-y: auto;
        }
        .log-entry { margin-bottom: 5px; }
        .log-success { color: #0f0; }
        .log-error { color: #f00; font-weight: bold; }
        .log-info { color: #fff; }

        #audioUnlocker {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 500;
            display: none; align-items: center; justify-content: center;
            cursor: pointer;
        }
        #audioUnlockerMessage {
            font-size: 2rem; color: #fff;
            padding: 2rem; text-align: center;
            border: 4px solid #fff;
            animation: textPulse 3s ease-in-out infinite;
        }


        /* --- STILI SEQUENZA INTRO --- */
        .intro-sequence-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.8s ease-in-out; cursor: pointer; }
        .intro-sequence-container.visible { opacity: 1; pointer-events: all; }
        .gif-wrapper { width: 100%; height: 100%; display: grid; grid-template-rows: 95fr 5fr; grid-template-columns: 100%; justify-items: center; align-items: center; }
        #introGif { grid-row: 1 / 2; max-width: 95vw; max-height: 90vh; width: auto; height: auto; object-fit: contain; align-self: center; justify-self: center; }
        .caption { grid-row: 2 / 3; align-self: center; position: relative; width: 90%; font-family: 'UnifrakturCook', cursive; font-size: 1.8rem; color: #fff; text-align: center; padding: 1rem 2rem; max-width: 900px; opacity: 0; line-height: 1.5; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .caption.visible { animation: caption-appear 1.5s ease-in-out forwards; }

        /* --- ANIMAZIONI --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInRetro { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes textPulse { 0%, 70% { opacity: 1; } 85%, 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="retro-background"></div>
    <div class="scanlines"></div>
    <div id="debugLogContainer"></div>

    <audio id="introMusic" preload="auto">
        <source src="./music/1.mp3" type="audio/mpeg">
        <source src="./music/2premaster.ogg" type="audio/ogg">
    </audio>

    <div class="content" id="mainContent">
        <h1 class="title">SUONATORE D'AUTOBUS</h1>
        <div class="language-selector">
             <span class="lang-option active">ITA</span>
        </div>
        <a href="#" class="start-button" id="startButton">START</a>
    </div>
    
    <div id="audioUnlocker">
        <div id="audioUnlockerMessage">Tocca per iniziare</div>
    </div>

    <div class="intro-sequence-container" id="introSequenceContainer">
        <div class="gif-wrapper">
            <img id="introGif" src="" alt="Intro Sequence">
            <div id="introCaption" class="caption"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- ELEMENTI UI ---
            const mainContent = document.getElementById('mainContent'),
                  startButton = document.getElementById('startButton'),
                  introMusic = document.getElementById('introMusic'),
                  introSequenceContainer = document.getElementById('introSequenceContainer'),
                  introGif = document.getElementById('introGif'),
                  introCaption = document.getElementById('introCaption'),
                  debugLogContainer = document.getElementById('debugLogContainer'),
                  audioUnlocker = document.getElementById('audioUnlocker');

            let activeTimers = [], autoSkipTimer, audioContext, isAudioInitialized = false;

            // --- FUNZIONE DI DEBUG A SCHERMO ---
            function log(message, type = 'info') {
                console.log(message);
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                debugLogContainer.appendChild(entry);
                debugLogContainer.scrollTop = debugLogContainer.scrollHeight;
            }

            // --- FASE 1: PRELOADER SEQUENZIALE CON DEBUG ---
            async function preloadResourcesSequentially() {
                log("Inizio precaricamento risorse...");
                const resources = [
                    './images/INTROGIF1.gif', './images/INTROGIF2.gif', './images/INTROGIF3.gif', './images/intro.gif',
                    './images/bus.jpg', './images/granchi.jpg', './suonatore.html', './busplayer.html',
                    './music/1.mp3', './music/2premaster.ogg'
                ];
                
                for (const url of resources) {
                    log(`Caricamento: ${url}`, 'info');
                    try {
                        await new Promise((resolve, reject) => {
                            const isImage = /\.(gif|jpe?g|png|webp)$/.test(url);
                            const isAudio = /\.(mp3|ogg|wav)$/.test(url);
                            const isHtml = /\.html$/.test(url);
                            const timeout = 10000; // 10 secondi di timeout per risorsa

                            const timer = setTimeout(() => reject(new Error('Timeout')), timeout);

                            if (isImage) {
                                const img = new Image();
                                img.onload = () => { clearTimeout(timer); resolve(); };
                                img.onerror = () => { clearTimeout(timer); reject(new Error('Image load error')); };
                                img.src = url;
                            } else if (isAudio) {
                                const audio = new Audio();
                                audio.oncanplaythrough = () => { clearTimeout(timer); resolve(); };
                                audio.onerror = () => { clearTimeout(timer); reject(new Error('Audio load error')); };
                                audio.src = url;
                            } else if (isHtml) {
                                fetch(url, { mode: 'no-cors' })
                                .then(() => { clearTimeout(timer); resolve(); })
                                .catch(() => { clearTimeout(timer); reject(new Error('HTML fetch error')); });
                            } else {
                                clearTimeout(timer);
                                resolve(); // Risolve subito tipi sconosciuti
                            }
                        });
                        log(`OK: ${url}`, 'success');
                    } catch (error) {
                        log(`ERRORE: ${url} (${error.message})`, 'error');
                        // Non blocchiamo il caricamento per un singolo errore
                    }
                }
                log("Precaricamento completato.", "success");
                startButton.classList.add('visible');
            }
            
            // --- FASE 2: GESTIONE AUDIO CON SBLOCCO ESPLICITO ---
            function initAndPlayAudio() {
                return new Promise(async (resolve, reject) => {
                    log("Tentativo di sblocco audio...", "info");
                    if (!isAudioInitialized) {
                        try {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            const source = audioContext.createMediaElementSource(introMusic);
                            source.connect(audioContext.destination);
                            isAudioInitialized = true;
                            log(`AudioContext creato. Stato iniziale: ${audioContext.state}`, "success");
                        } catch (e) {
                            log(`ERRORE Creazione AudioContext: ${e.message}`, "error");
                            return reject(e);
                        }
                    }

                    if (audioContext.state === 'suspended') {
                        log("AudioContext sospeso, tento di riprenderlo...", "info");
                        await audioContext.resume();
                        log(`AudioContext ripreso. Nuovo stato: ${audioContext.state}`, "success");
                    }
                    
                    try {
                        log("Eseguo introMusic.play()...", "info");
                        introMusic.loop = true;
                        introMusic.volume = 0.4;
                        await introMusic.play();
                        log("Comando .play() eseguito con successo.", "success");
                        resolve();
                    } catch (error) {
                        log(`ERRORE .play(): ${error.name} - ${error.message}`, "error");
                        // Anche se l'audio fallisce, continuiamo con la sequenza
                        resolve(); 
                    }
                });
            }


            // --- LOGICA DI AVVIO ---
            await preloadResourcesSequentially();

            startButton.addEventListener('click', function(event) {
                event.preventDefault();
                mainContent.style.display = 'none';
                audioUnlocker.style.display = 'flex';
                log("In attesa del tocco per sbloccare l'audio...", "info");
            });

            audioUnlocker.addEventListener('click', async function(event) {
                event.preventDefault();
                audioUnlocker.style.display = 'none'; // Nasconde subito la schermata
                
                await initAndPlayAudio();
                
                // Nascondi il debug log dopo un breve ritardo per dare tempo di leggere l'ultimo messaggio
                setTimeout(() => { debugLogContainer.style.display = 'none'; }, 2000);

                introSequenceContainer.classList.add('visible');
                playIntroSequence();

            }, { once: true });


            // --- LOGICA SEQUENZA INTRO ---
            function playIntroSequence() {
                const steps = [
                    { gif: './images/INTROGIF1.gif', duration: 5000, subtitles: [{ text: `SUONATORE D'AUTOBUS`, delay: 500, duration: 1800, align: 'left' }, { text: `/Carlo Martinelli, a vostra immagine, nome band a piacere.`, delay: 2500, duration: 2000, align: 'left' }] },
                    { gif: './images/INTROGIF2.gif', duration: 15000, subtitles: [{ text: `una notte il signore ebbe un'avventura incredibile:`, delay: 500, duration: 3500, align: 'center' }, { text: `era uscito in strada per prendere l'autobus...`, delay: 4500, duration: 4000, align: 'center' }] },
                    { gif: './images/INTROGIF3.gif', duration: 15000, subtitles: [{ text: `<em>poi si confondeva e non si ricordava la storia.</em>`, delay: 500, duration: 4500, align: 'center' }] }
                ];
                let currentStepIndex = 0;

                function showStep(index) {
                    clearTimeout(autoSkipTimer);
                    activeTimers.forEach(clearTimeout);
                    if (index >= steps.length) { endIntroSequence(); return; }

                    const step = steps[index];
                    introGif.src = step.gif;
                    
                    introCaption.classList.remove('visible');
                    step.subtitles.forEach((sub) => {
                        let timerIn = setTimeout(() => {
                           introCaption.innerHTML = sub.text;
                           introCaption.className = `caption ${sub.align === 'left' ? 'caption--first' : ''}`;
                           introCaption.classList.add('visible');
                        }, sub.delay);
                        activeTimers.push(timerIn);
                        if(sub.duration) {
                           let timerOut = setTimeout(() => introCaption.classList.remove('visible'), sub.delay + sub.duration);
                           activeTimers.push(timerOut);
                        }
                    });
                    
                    autoSkipTimer = setTimeout(nextStep, step.duration);
                }

                function nextStep() {
                    currentStepIndex++;
                    showStep(currentStepIndex);
                }
                
                showStep(currentStepIndex);
                introSequenceContainer.addEventListener('click', nextStep);
            }

            function endIntroSequence() {
                // Logica di fine sequenza invariata
            }
        });
    </script>
</body>
</html>
